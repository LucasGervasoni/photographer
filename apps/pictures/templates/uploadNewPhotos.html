{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title%}
<title>Spotlight - Upload</title>
{% endblock %}

{% block content %}
<h2 class="mb-4 h5">Upload Images for {{ order }}</h2>
<style>
    .help-img{
        width: 340px; 
        position: absolute; 
        top: 10%; 
        left: 0;
    }

    @media screen and (min-width:320px) and (max-width:767px){
        .help-img{
            display: none;
        }
    }

    @media screen and (min-width:768px) and (max-width:1439px){
        .help-img{
            min-width: 200px;
            width: 250px;
            max-width: 320px;

        }
    }
    @media screen and (min-width:1660px) and (max-width:2100px){
        .help-img{
            left: 10%;

        }
    }
    @media screen and (min-width:2100px){
        .help-img{
            left: 20%;

        }
    }
</style>


<img class="help-img" src="{% static 'img/help-img.jpg' %}" alt="">
<form id="uploadForm" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="d-flex flex-column w-80 mr-auto ml-auto align-items-center" style="max-width: 1200px;">
        <div class="box__input mb-4 align-self-center">
            <input class="fileInput" type="file" accept="*" webkitdirectory directory name="image" multiple data-path>
        </div>

        <!-- Editor Note -->
        <div class="form-group w-50">
            <label for="id_editor_note">Editor Note:</label>
            <textarea class="form-control" name="editor_note" id="id_editor_note" cols="40" rows="3"></textarea>
        </div>

        <!-- Selected Service -->
        <div class="form-group w-50">
            <label for="id_services">Services:</label>
            {{ group_form.services }}
        </div>

        <!-- 3D Scan URL -->
        <div class="form-group w-50">
            <label for="id_scan_url">3D Scan URL (if applicable):</label>
            <input class="form-control" type="url" name="scan_url" placeholder="Enter URL for 3d scan" maxlength="200" id="id_scan_url" disabled="">
        </div>

        <div class="d-flex justify-content-between w-50">
            <a class="btn btn-info" href="{% url 'userOrders--page' %}">Back to Orders</a>
            <button class="btn btn-success" type="submit">Upload</button>
        </div>
    </div>
</form>

<div id="progressCard" class="progress-card" style="display:none;">
    <div class="progress-header">
        <strong>Progress</strong>
    </div>
    <div class="progress-details">
        <p id="fileName">File: </p>
    </div>
    <div class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped bg-primary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="progress-footer">
        <p id="progressPercent" class="text-center">0% Complete</p>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    var uploadForm = document.getElementById('uploadForm');
    var servicesField = document.getElementById('id_services');
    var scanUrlField = document.getElementById('id_scan_url');
    var fileInputField = document.querySelector('.fileInput');
    var progressCard = document.getElementById('progressCard');
    var progressBar = document.getElementById('progressBar');
    var fileNameElement = document.getElementById('fileName');
    var progressPercent = document.getElementById('progressPercent');
    var retryLimit = 5;
    var baseTimeout = 60000; // Timeout 60 seconds
    var groupId;

    // Enable or disable the scan URL field and file input based on selected services
    function updateFields() {
        var selectedServices = Array.from(servicesField.querySelectorAll('input[type="checkbox"]:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedServices.includes('3d scan') && selectedServices.length === 1) {
            // If only "3D scan" is selected, disable the file input
            scanUrlField.disabled = false;
            fileInputField.disabled = true;
        } else if (selectedServices.length > 0 && !selectedServices.includes('3d scan')) {
            // If at least one service other than "3D scan" is selected, enable the file input
            scanUrlField.disabled = true;
            scanUrlField.value = '';  // Clear the field if disabled
            fileInputField.disabled = false;
        } else {
            // If no services are selected, disable both fields
            scanUrlField.disabled = true;
            scanUrlField.value = '';  // Clear the field if disabled
            fileInputField.disabled = true;
        }
    }

    // Attach the event listener to update the fields when the services change
    servicesField.addEventListener('change', updateFields);

    // Call the function initially to set the correct state
    updateFields();
    
    uploadForm.onsubmit = async function (event) {
        event.preventDefault();
        var formData = new FormData(uploadForm);
        var files = document.querySelector('.fileInput').files;

        if (files.length === 0 && !formData.get('scan_url')) {
            alert('No files were selected and no 3D scan URL provided.');
            return;
        }

        // Make an AJAX call to create a new group of images
        try {
            groupId = await createOrderImageGroup();
        } catch (error) {
            alert('Error creating image group.');
            return;
        }

        formData.append('group_id', groupId); // Add the new group_id to formData

        if (files.length > 0) {
            progressCard.style.display = 'block';

            uploadForm.querySelectorAll('input, button, textarea').forEach(function (element) {
                element.disabled = true;
            });

            try {
                for (let file of files) {
                    let relativePath = file.webkitRelativePath 
                        ? file.webkitRelativePath.replace(file.name, '') 
                        : '';  // Exclude the filename from the relative path
                    formData.append('relative_path', relativePath);
                    await uploadFileWithRetries(file, formData, uploadForm.action);
                    formData.delete('relative_path');  // Clean up after each file
                }
                window.location.href = "{% url 'userOrders--page' %}";
            } catch (error) {
                alert(error.message || 'Error during upload.');
            } finally {
                progressCard.style.display = 'none';

                uploadForm.querySelectorAll('input, button, textarea').forEach(function (element) {
                    element.disabled = false;
                });
            }
        } else {
            try {
                await submitFormWithoutFiles(formData, uploadForm.action);
                window.location.href = "{% url 'userOrders--page' %}";
            } catch (error) {
                alert(error.message || 'Error submitting form.');
            }
        }
    };

    async function createOrderImageGroup() {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "create_order_image_group" order.pk %}', true);
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

            xhr.onload = function () {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.status === 'success') {
                        resolve(response.group_id);
                    } else {
                        reject(new Error('Error creating image group.'));
                    }
                } else {
                    reject(new Error('Error creating image group.'));
                }
            };

            xhr.onerror = function () {
                reject(new Error('Error creating image group.'));
            };

            xhr.send();
        });
    }

    async function uploadFileWithRetries(file, formData, actionUrl, retries = 0) {
        try {
            await uploadFileAsync(file, formData, actionUrl);
        } catch (error) {
            if (retries < retryLimit) {
                const delay = Math.pow(2, retries) * 1000; // Exponential backoff
                await new Promise(resolve => setTimeout(resolve, delay));
                return uploadFileWithRetries(file, formData, actionUrl, retries + 1);
            } else {
                throw error;
            }
        }
    }

    async function uploadFileAsync(file, formData, actionUrl) {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', actionUrl, true);
            xhr.timeout = baseTimeout + (file.size / (1024 * 1024)) * 1000; // Adaptive timeout

            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    var percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressBar.setAttribute('aria-valuenow', percentComplete);
                    progressPercent.textContent = percentComplete + '% Complete';
                }
            };

            xhr.onloadstart = function () {
                fileNameElement.textContent = 'File: ' + file.name;
                progressBar.style.width = '0%';
                progressPercent.textContent = '0% Complete';
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    resolve();
                } else {
                    reject(new Error('Error during upload.'));
                }
            };

            xhr.onerror = function () {
                reject(new Error('Upload failed.'));
            };

            xhr.ontimeout = function () {
                reject(new Error('Upload timed out.'));
            };

            var uploadData = new FormData();
            uploadData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));
            uploadData.append('image', file);
            uploadData.append('relative_path', formData.get('relative_path'));  // Include relative path
            uploadData.append('editor_note', formData.get('editor_note'));
            uploadData.append('services', formData.get('services'));
            uploadData.append('scan_url', formData.get('scan_url'));
            uploadData.append('group_id', formData.get('group_id')); // Add group_id to uploadData

            xhr.send(uploadData);
        });
    }

    async function submitFormWithoutFiles(formData, actionUrl) {
        return new Promise((resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', actionUrl, true);
            xhr.timeout = baseTimeout;

            xhr.onload = function () {
                if (xhr.status === 200) {
                    resolve();
                } else {
                    reject(new Error('Error submitting form.'));
                }
            };

            xhr.onerror = function () {
                reject(new Error('Form submission failed.'));
            };

            xhr.ontimeout = function () {
                reject(new Error('Form submission timed out.'));
            };

            xhr.send(formData);
        });
    }
});



</script>
    

<br>
{% endblock %}