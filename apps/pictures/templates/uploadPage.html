{% extends 'base.html' %}
{% load static %}

{% block title%}
<title>Spotlight - Upload</title>
{% endblock %}

{% block content %}
<h2 class="mb-4 h5">Upload Images for {{ order }}</h2>
<form id="uploadForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="d-flex flex-column w-80 mr-auto ml-auto align-items-center">
        <div class="box__input mb-4 align-self-center">
            <input class="fileInput" type="file" accept="*" name="image" multiple>
        </div>

        <!-- Editor Note -->
        <div class="form-group w-50">
            <label for="id_editor_note">Editor Note:</label>
            <textarea class="form-control" name="editor_note" id="id_editor_note" cols="40" rows="3"></textarea>
        </div>

        <!-- Selected Service -->
        <div class="form-group w-50">
            <label for="id_services">Services:</label>
            {{ group_form.services }}
        </div>

        <!-- 3D Scan URL -->
        <div class="form-group w-50">
            <label for="id_scan_url">3D Scan URL (if applicable):</label>
            <input class="form-control" type="url" name="scan_url" placeholder="Enter URL for 3d scan" maxlength="200" id="id_scan_url" disabled="">
        </div>

        <div class="d-flex flex-wrap w-50">
            <!-- Photos Sent -->
            <div class="form-group mr-2">
                <label for="id_photos_sent">Assets to be uploaded:</label>
                <input class="form-control" type="number" name="photos_sent" min="0" required="" id="id_photos_sent">
            </div>

            <!-- Photos Returned -->
            <div class="form-group">
                <label for="id_photos_returned">Assets to be returned:</label>
                <input class="form-control" type="number" name="photos_returned" min="0" id="id_photos_returned">
            </div>
        </div>

        <div class="d-flex justify-content-between w-50">
            <a class="btn btn-info" href="{% url 'userOrders--page' %}">Back to Orders</a>
            <button class="btn btn-success" type="submit">Upload</button>
        </div>
    </div>
</form>

<div id="progressCard" class="progress-card" style="display:none;">
    <div class="progress-header">
        <strong>Progress</strong>
    </div>
    <div class="progress-details">
        <p id="fileName">File: </p>
    </div>
    <div class="progress">
        <div id="progressBar" class="progress-bar progress-bar-striped bg-primary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <div class="progress-footer">
        <p id="progressPercent" class="text-center">0% Complete</p>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        var servicesField = document.getElementById('id_services');
        var scanUrlField = document.getElementById('id_scan_url');
        var progressCard = document.getElementById('progressCard');
        var progressBar = document.getElementById('progressBar');
        var fileNameElement = document.getElementById('fileName');
        var progressPercent = document.getElementById('progressPercent');
        var uploadForm = document.getElementById('uploadForm');
        var retryLimit = 5;
        var baseTimeout = 60000; // Timeout 60 seconds
    
        function updateScanUrlField() {
            var selectedServices = Array.from(servicesField.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            if (selectedServices.includes('3d scan')) {
                scanUrlField.disabled = false;
            } else {
                scanUrlField.disabled = true;
                scanUrlField.value = '';
            }
        }
    
        servicesField.addEventListener('change', updateScanUrlField);
        updateScanUrlField();
    
        uploadForm.onsubmit = async function (event) {
            event.preventDefault();
            var formData = new FormData(uploadForm);
            var files = formData.getAll('image');  
    
            if (files.length === 0) {
                alert('No files were selected.');
                return;
            }
    
            progressCard.style.display = 'block';
    
            uploadForm.querySelectorAll('input, button, textarea').forEach(function (element) {
                element.disabled = true;
            });
    
            try {
                for (let file of files) {
                    await uploadFileWithRetries(file, formData, uploadForm.action);
                }
                window.location.href = "{% url 'userOrders--page' %}"; 
            } catch (error) {
                alert(error.message || 'Error during upload.');
            } finally {
                progressCard.style.display = 'none';
    
                uploadForm.querySelectorAll('input, button, textarea').forEach(function (element) {
                    element.disabled = false;
                });
            }
        };
    
        async function uploadFileWithRetries(file, formData, actionUrl, retries = 0) {
            try {
                await uploadFileAsync(file, formData, actionUrl);
            } catch (error) {
                if (retries < retryLimit) {
                    const delay = Math.pow(2, retries) * 1000; // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return uploadFileWithRetries(file, formData, actionUrl, retries + 1);
                } else {
                    throw error;
                }
            }
        }
    
        async function uploadFileAsync(file, formData, actionUrl) {
            return new Promise((resolve, reject) => {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', actionUrl, true);
                xhr.timeout = baseTimeout + (file.size / (1024 * 1024)) * 1000; // Timeout adaptativo
    
                xhr.upload.onprogress = function (event) {
                    if (event.lengthComputable) {
                        var percentComplete = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.setAttribute('aria-valuenow', percentComplete);
                        progressPercent.textContent = percentComplete + '% Complete';
                    }
                };
    
                xhr.onloadstart = function () {
                    fileNameElement.textContent = 'File: ' + file.name;
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0% Complete';
                };
    
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        resolve();
                    } else {
                        reject(new Error('Error during upload.'));
                    }
                };
    
                xhr.onerror = function () {
                    reject(new Error('Upload timed out.'));
                };
    
                xhr.ontimeout = function () {
                    reject(new Error('O upload atingiu o tempo limite.'));
                };
    
                var uploadData = new FormData();
                uploadData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));
                uploadData.append('image', file); // Envia o arquivo correto aqui
                uploadData.append('editor_note', formData.get('editor_note'));
                uploadData.append('services', formData.get('services'));
                uploadData.append('scan_url', formData.get('scan_url'));
                uploadData.append('photos_sent', formData.get('photos_sent'));
                uploadData.append('photos_returned', formData.get('photos_returned'));
    
                xhr.send(uploadData);
            });
        }
    });
</script>
{% endblock %}