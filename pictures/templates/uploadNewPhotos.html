{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title%}
<title>Spotlight - Upload</title>
{% endblock %}

{% block content %}
<h2 class="mb-4 h5">Upload Images for {{ order }}</h2>
<form id="uploadForm" action="" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="d-flex flex-column w-80 mr-auto ml-auto align-items-center">
    <div class="box__input mb-4 align-self-center">
      <input class="fileInput" type="file" accept="*" name="image" multiple>
    </div>

    <!-- Editor Note -->
    <div class="form-group w-50">
      <label for="id_editor_note">Editor Note:</label>
      <textarea class="form-control" name="editor_note" id="id_editor_note" cols="40" rows="3"></textarea>
    </div>

    <!-- Selected Service -->
    <div class="form-group w-50">
        <label for="id_services">Services:</label>
        {{ group_form.services }}
    </div>

    <!-- 3D Scan URL -->
    <div class="form-group w-50">
      <label for="id_scan_url">3D Scan URL (if applicable):</label>
      <input class="form-control" type="url" name="scan_url" placeholder="Enter URL for 3d scan" maxlength="200" id="id_scan_url" disabled="">
    </div>

    <div class="d-flex justify-content-between w-50">
      <a class="btn btn-info" href="{% url 'userOrders--page' %}">Back to Orders</a>
      <button class="btn btn-success" type="submit">Upload</button>
    </div>
  </div>
</form>

<!-- Progress Bar -->
<div class="progress mt-3 w-50 ml-auto mr-auto">
  <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">
    <span id="progressText">0% Complete</span>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var servicesField = document.getElementById('id_services');
    var scanUrlField = document.getElementById('id_scan_url');

    // Function to enable or disable the URL field based on the services selection
    function updateScanUrlField() {
      var selectedServices = Array.from(servicesField.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
      if (selectedServices.includes('3d scan')) {
        scanUrlField.disabled = false;
      } else {
        scanUrlField.disabled = true;
        scanUrlField.value = ''; // Optionally clear the field if not enabled
      }
    }

    // Attach event listeners to checkboxes
    servicesField.addEventListener('change', updateScanUrlField);

    // Initial check on page load
    updateScanUrlField();

    var uploadForm = document.getElementById('uploadForm');
    var progressBar = document.getElementById('progressBar');
    var progressText = document.getElementById('progressText');

    // AJAX upload
    uploadForm.onsubmit = function(event) {
      event.preventDefault();
      var formData = new FormData(uploadForm);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', uploadForm.action, true);

      xhr.upload.addEventListener('progress', function(event) {
        if (event.lengthComputable) {
          var percentComplete = (event.loaded / event.total) * 100;
          progressBar.style.width = percentComplete + '%';
          progressText.textContent = Math.round(percentComplete) + '% Complete';
        }
      });

      xhr.onload = function() {
        if (xhr.status === 200) {
          progressBar.style.width = '100%';
          progressText.textContent = 'Upload Complete!';
          var response = JSON.parse(xhr.responseText);
          if (response.status === 'success') {
            window.location.href = "{% url 'userOrders--page' %}";
          } else {
            progressText.textContent = response.message || 'Error during upload.';
          }
        } else {
          progressText.textContent = 'Error during upload.';
        }
      };

      xhr.send(formData);
    };
  });
</script>
<br>
{% endblock %}
